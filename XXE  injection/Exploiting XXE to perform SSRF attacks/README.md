## Lab Description :

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/8a48dc2a-abeb-432f-9937-0b37e17b05c5)

#### Exploiting XXE to perform SSRF attacks

Aside from retrieval of sensitive data, the other main impact of XXE attacks is that they **can be used to perform server-side request forgery (SSRF)**. This is a potentially serious vulnerability in which the server-side application can be induced to make HTTP requests to any URL that the server can access.

To exploit an XXE vulnerability to perform an SSRF attack, you need to **define an external XML entity using the URL that you want to target**, and **use the defined entity within a data value**. If you can use the defined entity within a data value that is returned in the application's response, then you will be able to view the response from the URL within the application's response, and so gain two-way interaction with the back-end system. If not, then you will only be able to perform blind SSRF attacks (which can still have critical consequences).

In the following XXE example, the external entity will cause the server to make a back-end HTTP request to an internal system within the organization's infrastructure:

```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://internal.vulnerable-website.com/"> ]>
```

## Solution :

Visit a product page, click "Check stock", and intercept the resulting POST request in Burp Suite.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/ff84a20a-07d7-4125-bcd4-ce3b4fdbd3f4)

Send the request to repeater.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/1bf9af28-be42-450a-b9d3-c99501f99d20)


Insert the following external entity definition in between the XML declaration and the stockCheck element:

```xml
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest"> ]>
```

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/96cdd672-c4bc-4b0b-a9b0-3b865115658f)

Replace the productId number with a reference to the external entity:

```xml
&xxe;
```
![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/b5fcd892-39f1-42f2-9573-dc69641749af)

The response should contain "Invalid product ID:" followed by the response from the metadata endpoint, which will initially be a folder name.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/f15034f0-5614-4780-815b-2ff59458af98)

 update  `/latest/meta-data`

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/116e80e3-569f-4533-bc95-614ef5fe7a56)

Iteratively update the URL in the DTD to explore the API until you reach `/latest/meta-data/iam/security-credentials/admin`. This should return JSON containing the SecretAccessKey.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/7a893a53-5096-44af-9cc0-d8f9f1f8e674)

Lab solved.

![image](https://github.com/ananthan05/Portswigger_labs/assets/140697378/4318aa33-9835-4397-a074-33a3baac986a)

